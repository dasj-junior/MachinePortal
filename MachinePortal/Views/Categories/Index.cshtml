@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model IEnumerable<MachinePortal.Models.Category>
@* Check User Permissions *@
@using Microsoft.AspNetCore.Identity
@using MachinePortal.Areas.Identity.Data
@using Microsoft.EntityFrameworkCore
@inject UserManager<MachinePortalUser> UserManager
@inject IdentityContext identityContext
@{
    var user = await UserManager.GetUserAsync(User);
    List<string> permissions = new List<string>();
    if (user != null) { permissions = ((from obj in identityContext.UserPermission select obj).Include(p => p.Permission).Where(x => x.UserID == user.Id).ToList()).Select(p => p.Permission.PermissionName).ToList(); };
    if (!permissions.Contains("PageCategories")) { Context.Response.Redirect("/Home/AccessDenied"); };
}

<script>
    function renderPartialEdit(ID) {
        $.ajax({
            url: '@Url.Action("AddPartialEdit", "Categories")',
            data: { id: ID},
            type: "POST",
            success: function(data) {
                $('#modalEdit').html(data);
            }
        });
    }

    function renderPartialDelete(ID) {
        $.ajax({
            url: '@Url.Action("AddPartialDelete", "Categories")',
            data: { id: ID},
            type: "POST",
            success: function(data) {
                $('#modalDelete').html(data);
            }
        });
    }
</script>

<div class="row justify-content-center">
    <div class="col-8">
        <div class="card fb-card c-vitesco-green-02">
            <div class="card-header c-vitesco-green-02">
                <i style="vertical-align:middle" class="bi-grid c-vitesco-green-02"></i>
                <div class="d-inline-block">
                    <h2 style="color:white;">@Localizer["Categories"].Value</h2>
                </div>
            </div>
            <div class="card-block card-padding">
                <div>
                    @if (permissions.Contains("CategoriesCreate"))
                    {
                        <button class="btn btn-primary btn-create" data-toggle="modal" data-target="#modalCreate">@Localizer["Create New Category"].Value</button>
                    }
                    <div class="table-responsive">
                        <table style="table-layout:auto;" class="table table-hover table-bordered table-vitesco">
                            <thead class="thead-vitesco">
                                <tr>
                                    <th width="80%">@Html.DisplayNameFor(model => model.Name)</th>
                                    <th width="20%" class="text-center">@Localizer["Options"].Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@Html.DisplayFor(modelItem => item.Name)</td>
                                        <td class="text-center ws-nowrap">
                                            @if (permissions.Contains("CategoriesEdit"))
                                            {
                                                <button class="btn btn-primary" data-toggle="modal" onclick="renderPartialEdit(@item.ID)" data-target="#modalEdit">@Localizer["Edit"].Value</button>
                                            }
                                            @if (permissions.Contains("CategoriesDelete"))
                                            {
                                                <button class="btn btn-danger" data-toggle="modal" onclick="renderPartialDelete(@item.ID)" data-target="#modalDelete">@Localizer["Delete"].Value</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modalCreate" role="dialog">
    @Html.Partial("Create", new Category());
</div>
<div class="modal" id="modalEdit" role="dialog">
</div>
<div class="modal" id="modalDelete" role="dialog">
</div>
