@model MachinePortal.Models.ViewModels.MachineFormViewModel

@{
    ViewData["Title"] = "Create new machine";
}

<script src="~/lib/jquery/dist/jquery.min.js"></script>

@* Form Data Variable *@
<script type="text/javascript">
    var formdata = new FormData();
</script>

@* Send files through AJAX *@
<script type="text/javascript">

    function DeleteFile(Fileid, FileName) {
        formdata.delete(FileName)
        $("#" + Fileid).remove();
        chkatchtbl();
    }

    function chkatchtbl() {
        if ($('#tDocuments tr').length > 1) {
            $("#tDocuments").css("visibility", "visible");
        } else {
            $("#tDocuments").css("visibility", "hidden");
        }
        if ($('#tImages tr').length > 1) {
            $("#tImages").css("visibility", "visible");
        } else {
            $("#tImages").css("visibility", "hidden");
        }
        if ($('#tVideos tr').length > 1) {
            $("#tVideos").css("visibility", "visible");
        } else {
            $("#tVideos").css("visibility", "hidden");
        }
    }

    $(document).ready(function () {

        document.getElementById('openInputDocument').addEventListener('click', () => {
            document.getElementById('iDocuments').click()
        });

        document.getElementById('openInputImage').addEventListener('click', () => {
            document.getElementById('iImages').click()
        });

        document.getElementById('openInputVideo').addEventListener('click', () => {
            document.getElementById('iVideos').click()
        });

        $("#iDocuments").on("change", function () {
            var fileInput = document.getElementById('iDocuments');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                document.getElementById("documentFilePath").value = sfilename;
            }
        });

        $("#iImages").on("change", function () {
            var fileInput = document.getElementById('iImages');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                document.getElementById("imageFilePath").value = sfilename;
            }
        });

        $("#iVideos").on("change", function () {
            var fileInput = document.getElementById('iVideos');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                document.getElementById("videoFilePath").value = sfilename;
            }
        });

        $("#insertDocument").on("click", function () {
            var fileInput = document.getElementById('iDocuments');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                var sName = document.getElementById('documentName').value;
                var sCategory = document.getElementById('documentCategory').value;
                let srandomid = Math.random().toString(36).substring(7);
                formdata.append("document", fileInput.files[i]);
                var markup = "<tr id='" + srandomid + "'><td>" + sName + "</td><td>" + sCategory + "</td><td>" + sfilename + "</td><td><a href='#' onclick='DeleteFile(\"" + srandomid + "\",\"" + sfilename +
                    "\")'><span class='glyphicon glyphicon-remove' style='color: red'></span></a></td></tr>"; // Binding the file name
                $("#tDocuments").append(markup);
            }
            chkatchtbl();
            $('#iDocuments').val('');
        });

        $("#insertImage").on("click", function () {
            var fileInput = document.getElementById('iImages');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                var sName = document.getElementById('imageName').value;
                var sCategory = document.getElementById('imageCategory').value;
                let srandomid = Math.random().toString(36).substring(7);
                formdata.append("image", fileInput.files[i]);
                var markup = "<tr id='" + srandomid + "'><td>" + sName + "</td><td>" + sCategory + "</td><td>" + sfilename + "</td><td><a href='#' onclick='DeleteFile(\"" + srandomid + "\",\"" + sfilename +
                    "\")'><span class='glyphicon glyphicon-remove' style='color: red'></span></a></td></tr>"; // Binding the file name
                $("#tImages").append(markup);
            }
            chkatchtbl();
            $('#iImages').val('');
        });

        $("#insertVideo").on("click", function () {
            var fileInput = document.getElementById('iVideos');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                var sName = document.getElementById('videoName').value;
                var sCategory = document.getElementById('videoCategory').value;
                let srandomid = Math.random().toString(36).substring(7);
                formdata.append("video", fileInput.files[i]);
                var markup = "<tr id='" + srandomid + "'><td>" + sName + "</td><td>" + sCategory + "</td><td>" + sfilename + "</td><td><a href='#' onclick='DeleteFile(\"" + srandomid + "\",\"" + sfilename +
                    "\")'><span class='glyphicon glyphicon-remove' style='color: red'></span></a></td></tr>"; // Binding the file name
                $("#tVideos").append(markup);
            }
            chkatchtbl();
            $('#iVideos').val('');
        });

        $("form").submit(function (event) {
            event.preventDefault();
            var data = new FormData(this);
            for (var pair of formdata.entries()) {
                data.append(pair[0], pair[1]);
            }
            $.ajax({
                url: '@Url.Content("~/")' + "Machines/Create",
                type: "POST",
                contentType: false, // Not to set any content header
                processData: false, // Not to process data
                data: data,
                async: false,
                success: function () {
                    window.location.href = "/Machines/Index";
                },
                error: (error) => {
                    console.log(JSON.stringify(error));
                }
            });
        });
    });
</script>

@* Select all elements of "Select" on rigth side *@
<script type="text/javascript">
    $(document).ready(function () {
        $('#submit').click(function () {
            var selRes = document.getElementById("ResponsiblesSelected");
            for (i = 0; i < selRes.length; i++) {
                selRes.options[i].selected = 1;
            }
            var selDev = document.getElementById("DevicesSelected");
            for (i = 0; i < selRes.length; i++) {
                selDev.options[i].selected = 1;
            }
        });
    });
</script>

@* Move selections *@
<script type="text/javascript">
    $(document).ready(function () {
        $("#rightResponsibles").click(function () {
            $("#ResponsiblesSelect option:selected").remove().appendTo($("#ResponsiblesSelected"));
        })
        $("#leftResponsibles").click(function () {
            $("#ResponsiblesSelected option:selected").remove().appendTo($("#ResponsiblesSelect"));
        })
        $("#rightDevices").click(function () {
            $("#DevicesSelect option:selected").remove().appendTo($("#DevicesSelected"));
        })
        $("#leftDevices").click(function () {
            $("#DevicesSelected option:selected").remove().appendTo($("#DevicesSelect"));
        })
    });
</script>

@* Machine Photo Button and Preview *@
<script type="text/javascript">
    $(document).ready(function () {
        //Button triggers the photo file input
        document.getElementById('openPhoto').addEventListener('click', () => {
            document.getElementById('photo').click()
        });

        $("#photo").change(function () {
            //Get file name and put it into input
            var fileInput = document.getElementById('photo');
            for (i = 0; i < fileInput.files.length; i++) {
                var sfilename = fileInput.files[i].name;
                document.getElementById("photoFilePath").value = sfilename;
            }
            //Load file and show the preview
            if (typeof (FileReader) != "undefined") {
                var dvPreview = $("#divImageMediaPreview");
                dvPreview.html("");
                $($(this)[0].files).each(function () {
                    var file = $(this);
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img = $("<img />");
                        img.attr("style", "height:300px; padding: 10px");
                        img.attr("src", e.target.result);
                        dvPreview.append(img);
                    }
                    reader.readAsDataURL(file[0]);
                });
            } else {
                alert("This browser does not support HTML5.");
            }
        });
    });
</script>

@* Hierarchies Control *@
<script type="text/javascript">
    $(document).ready(function () {
        $('#AreaID').prepend("<option value='-1'>Select</option>");
        $('#AreaID option:contains(Select)').prop({ selected: true });
        $('#SectorID').append("<option value='-1'>Select</option>");
        $('#LineID').append("<option value='-1'>Select</option>");

        $('#AreaID').on('change', function() {
            var url = '@Url.Content("~/")' + "Machines/GetSector";
            $.getJSON(url, { AreaID: $("#AreaID :selected").val() }, function (data) {
                var items = '';
                $('#SectorID').html(items);
                $.each(data, function (i, sector) {
                    items += "<option value='" + sector.value + "'>" + sector.text + "</option>";
                });
                $('#SectorID').append("<option value='-1'>Select</option>");
                $('#SectorID').append(items);
                $('#LineID').html("");
                $('#LineID').append("<option value='-1'>Select</option>");
            });
        });

        $('#SectorID').on('change', function() {
            var url = '@Url.Content("~/")' + "Machines/GetLine";
            $.getJSON(url, { SectorID: $("#SectorID :selected").val() }, function (data) {
                var items = '';
                $('#LineID').html(items);
                $.each(data, function (i, line) {
                    items += "<option value='" + line.value + "'>" + line.text + "</option>";
                });
                $('#LineID').append("<option value='-1'>Select</option>");
                $('#LineID').append(items);
            });
        });
    });
</script>

<h2>@ViewData["Title"]</h2>
<hr />

<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" class="form" enctype="multipart/form-data" asp-controller="Machines">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <h3>General Data</h3>
            <hr />
            <div class="form-group">
                <label class="control-label">Photo</label>
                <div id="divImageMediaPreview"></div>
                <div class="input-group">
                    <span class="input-group-btn">
                        <button id="openPhoto" class="btn btn-default" type="button">
                            Open Photo
                        </button>
                    </span>
                    <input id="photoFilePath" type="text" class="form-control" placeholder="No file chosen" readonly />
                </div>
                <input type="file" id="photo" name="photo" accept="image/*" style="display:none" />
            </div>
            <div class="form-group">
                <label asp-for="Machine.Name" class="control-label"></label>
                <input asp-for="Machine.Name" class="form-control" />
                <span asp-validation-for="Machine.Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.Description" class="control-label"></label>
                <textarea asp-for="Machine.Description" class="form-control"></textarea>
                <span asp-validation-for="Machine.Description" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.AssetNumber" class="control-label"></label>
                <input asp-for="Machine.AssetNumber" class="form-control" />
                <span asp-validation-for="Machine.AssetNumber" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.MES_Name" class="control-label"></label>
                <input asp-for="Machine.MES_Name" class="form-control" />
                <span asp-validation-for="Machine.MES_Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.SAP_Name" class="control-label"></label>
                <input asp-for="Machine.SAP_Name" class="form-control" />
                <span asp-validation-for="Machine.SAP_Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.WorkCenter" class="control-label"></label>
                <input asp-for="Machine.WorkCenter" class="form-control" />
                <span asp-validation-for="Machine.WorkCenter" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.CostCenter" class="control-label"></label>
                <input asp-for="Machine.CostCenter" class="form-control" />
                <span asp-validation-for="Machine.CostCenter" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Machine.ServerPath" class="control-label"></label>
                <input asp-for="Machine.ServerPath" class="form-control" />
                <span asp-validation-for="Machine.ServerPath" class="text-danger"></span>
            </div>

            <br />
            <h2>Files</h2>
            <hr />

            <div class="form-group">
                <label class="control-label">Documents</label>
                <hr style="padding:0; margin:5px;" />
                <input id="iDocuments" type="file" style="display:none" />
                <button type="button" data-toggle="modal" data-target="#modalDocuments">Add Document</button>
                <br /><br />
                <table class="table table-bordered" id="tDocuments" style="visibility:hidden">
                    <tr>
                        <th>
                            Name
                        </th>
                        <th>
                            Category
                        </th>
                        <th>
                            File Name
                        </th>
                        <th>
                            Delete
                        </th>
                    </tr>
                </table>
            </div>

            <div class="form-group">
                <label class="control-label">Images</label>
                <hr style="padding:0; margin:5px;" />
                <input id="iImages" type="file" style="display:none" />
                <button type="button" data-toggle="modal" data-target="#modalImages">Add Images</button>
                <br /><br />
                <table class="table table-bordered" id="tImages" style="visibility:hidden">
                    <tr>
                        <th>
                            Name
                        </th>
                        <th>
                            Category
                        </th>
                        <th>
                            File Name
                        </th>
                        <th>
                            Delete
                        </th>
                    </tr>
                </table>
            </div>

            <div class="form-group">
                <label class="control-label">Videos</label>
                <hr style="padding:0; margin:5px;" />
                <input id="iVideos" type="file" style="display:none" />
                <button type="button" data-toggle="modal" data-target="#modalVideos">Add Videos</button>
                <br /><br />
                <table class="table table-bordered" id="tVideos" style="visibility:hidden">
                    <tr>
                        <th>
                            Name
                        </th>
                        <th>
                            Category
                        </th>
                        <th>
                            File Name
                        </th>
                        <th>
                            Delete
                        </th>
                    </tr>
                </table>
            </div>

            <br />
            <h3>Selection</h3>
            <hr />

            <div class="form-group">
                <label asp-for="Devices" class="control-label"></label>
                <div class="row">
                    <div class="col-md-5 col-sm-5">
                        <select id="DevicesSelect" asp-for="Devices" asp-items="@ViewBag.ListDevices" class="form-control" multiple></select>
                    </div>
                    <div class="col-md-2 col-sm-2">
                        <button type="button" id="rightDevices" class="btn btn-success btn-block glyphicon glyphicon-arrow-right"></button>
                        <button type="button" id="leftDevices" class="btn btn-success btn-block btn-danger glyphicon glyphicon-arrow-left"></button>
                    </div>
                    <div class="col-md-5 col-sm-5">
                        <select id="DevicesSelected" asp-for="SelectedDevices" class="form-control" multiple></select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="Responsibles" class="control-label"></label>
                <div class="row">
                    <div class="col-md-5 col-sm-5">
                        <select id="ResponsiblesSelect" asp-items="@ViewBag.ListResponsibles" class="form-control" multiple></select>
                    </div>
                    <div class="col-md-2 col-sm-2">
                        <button type="button" id="rightResponsibles" class="btn btn-success btn-block glyphicon glyphicon-arrow-right"></button>
                        <button type="button" id="leftResponsibles" class="btn btn-success btn-block btn-danger glyphicon glyphicon-arrow-left"></button>
                    </div>
                    <div class="col-md-5 col-sm-5">
                        <select id="ResponsiblesSelected" asp-for="SelectedResponsibles" class="form-control" multiple></select>
                    </div>
                </div>
            </div>

            <br />
            <h2>Hierarchies</h2>
            <hr />

            <div class="form-group">
                <label asp-for="Machine.AreaID" class="control-label"></label>
                <select asp-for="Machine.AreaID" id="AreaID" class="form-control" asp-items="@(new SelectList(@ViewBag.ListAreas,"ID","Name"))"></select>
            </div>

            <div class="form-group">
                <label asp-for="Machine.SectorID" class="control-label"></label>
                <select asp-for="Machine.SectorID" id="SectorID" class="form-control" asp-items="@(new SelectList(string.Empty, "ID","Name"))"></select>
            </div>

            <div class="form-group">
                <label asp-for="Machine.LineID" class="control-label"></label>
                <select asp-for="Machine.LineID" id="LineID" class="form-control" asp-items="@(new SelectList(string.Empty, "ID","Name"))"></select>
            </div>

            <br /><br />

            <div class="form-group">
                <input type="submit" id="submit" value="Create" class="btn btn-default" />
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalDocuments" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add New Document</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="control-label">Name:</label>
                    <input id="documentName" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Category:</label>
                    <input id="documentCategory" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">File:</label>
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button id="openInputDocument" class="btn btn-default" type="button">
                                Open File
                            </button>
                        </span>
                        <input id="documentFilePath" type="text" class="form-control" placeholder="No file chosen" readonly></input>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="insertDocument" class="btn btn-success">Insert</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalImages" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add New Image</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="control-label">Name:</label>
                    <input id="imageName" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Category:</label>
                    <input id="imageCategory" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">File:</label>
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button id="openInputImage" class="btn btn-default" type="button">
                                Open File
                            </button>
                        </span>
                        <input id="imageFilePath" type="text" class="form-control" placeholder="No file chosen" readonly></input>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="insertImage" class="btn btn-success">Insert</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVideos" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add New Video</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="control-label">Name:</label>
                    <input id="videoName" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Category:</label>
                    <input id="videoCategory" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">File:</label>
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button id="openInputVideo" class="btn btn-default" type="button">
                                Open File
                            </button>
                        </span>
                        <input id="videoFilePath" type="text" class="form-control" placeholder="No file chosen" readonly></input>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="insertVideo" class="btn btn-success">Insert</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>



<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
