@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@* Check User Permissions *@
@using Microsoft.AspNetCore.Identity
@using MachinePortal.Areas.Identity.Data
@using Microsoft.EntityFrameworkCore
@inject UserManager<MachinePortalUser> UserManager
@inject IdentityContext identityContext
@{
    var user = await UserManager.GetUserAsync(User);
    List<string> permissions = new List<string>();
    if (user != null) { permissions = ((from obj in identityContext.UserPermission select obj).Include(p => p.Permission).Where(x => x.UserID == user.Id).ToList()).Select(p => p.Permission.PermissionName).ToList(); };
}

<!-- Scripts JQuery and WebCodeCam -->
@*<script src="~/webcodecamjs/js/jquery.js"></script>
    <script src="~/webcodecamjs/js/qrcodelib.js"></script>
    <script src="~/webcodecamjs/js/webcodecamjquery.js"></script>*@
<script src="~/assets/js/html5-qrcode.min.js"></script>

@* Machine Search By Input ID *@
<script>

    $(document).ready(function () {

    });

    $(document).ready(function () {
        $(".note__close").click(function () {
            $(this).parent()
                .animate({ opacity: 0 }, 250, function () {
                    $(this)
                        .animate({ marginBottom: 0 }, 250)
                        .children()
                        .animate({ padding: 0 }, 250)
                        .wrapInner("<div />")
                        .children()
                        .slideUp(250, function () {
                            $(this).closest(".note").remove();
                        });
                });
        });
    });

    $(document).ready(function () {
        $("#SearchByID").on("click", function () {
            var id = $('#InputID').val();
            $.ajax({
                type: "POST",
                url: '@Url.Content("~/")' + "Home/ValidateMachineID",
                data: {"MachineID" : id },
                success: function (e) {
                    if (e == true) {
                        window.location.href = "Machines/Details/" + id;
                    }
                    else {
                        //options "success" "warning" "error" "secondary" "info"
                        notify(' Error: ', 'Machine Not Found', 'top', 'right', 'bi-x-circle', 'error', 'animated fadeInRight', 'animated fadeInRight')
                    }
                },
                async: true
            });
        });
    });
</script>

@* Machine Search By Hierarchies *@
<script>
    $(document).ready(function () {
        $("#SearchByHierarchies").on("click", function () {
            window.location.href = "Hierarchies/Index";
        });
    });
</script>
@* Machine Search By QR *@
<script>
    $(document).ready(function () {
        $("#SearchByQR").on("click", function () {
            html5QrcodeScanner.s
        });

        $('#modalQR').on('hidden.bs.modal', function () {
            html5QrcodeScanner.clear();
        })
    });
</script>

@* QR Code Decoder *@
<script type="text/javascript">
    function onScanSuccess(decodedText, decodedResult) {
            // Handle on success condition with the decoded message.
            $.ajax({
                type: "POST",
                url: '@Url.Content("~/")' + "Home/ValidateMachineID",
                data: { "MachineID": decodedText },
                success: function (e) {
                    if (e == true) {
                        window.location.href = "Machines/Details/" + decodedText;
                    }
                    else {
                        alert("Machine Not Found");
                    }
                },
                async: true
            });
    };
</script>

<body>
    <div>
        <div class="row">
            @*@if (permissions.Contains("HomeSearchByMachineID"))
                {*@
            <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4">
                <div class="card widget-card-1">
                    <div class="card-block-big">
                        <span class="bg-c-blue card1-icon" style="font-size: 28px;">123</span>
                        <br />
                        <h4 style="text-align: center;">
                            @Localizer["Search By Machine ID"].Value
                        </h4>
                        <div>
                            <span class="f-left" style=" width: 100%;">
                                <div class="pcoded-search-box" style="text-align:center; padding-top:20px;">
                                    <input id="InputID" placeholder="@Localizer["Type Machine ID"].Value" type="text" style="width: 50%; text-align:center">
                                    <a id="SearchByID" style="color: black; font-size: 12px; font-weight:700;" class="btn btn-success">@Localizer["Search"].Value</a>
                                </div>
                            </span>
                        </div>
                        <br />
                        <br />
                        <br />
                    </div>
                </div>
            </div>
            @*}
                @if (permissions.Contains("HomeSearchByQRCode"))
                {*@
            <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4">
                <div class="card widget-card-1">
                    <div class="card-block-big">
                        <i class="icofont icofont-qr-code bg-c-green card1-icon"></i>
                        <br />
                        <h4 style="text-align: center;">
                            @Localizer["Search By QR Code"].Value
                        </h4>
                        <br />
                        <div>
                            <span class="f-left" style="text-align:center; width: 100%;">
                                <button id="SearchByQR" style="width:100%; height:40px; color: black; font-size: 15px; font-weight:700;" class="btn btn-success" type="button" data-toggle="modal" data-target="#modalQR">@Localizer["Search"].Value</button>
                            </span>
                        </div>
                        <br />
                        <br />
                    </div>
                </div>
            </div>
            @*}
                @if (permissions.Contains("HomeSearchByHierarchies"))
                {*@
            <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4">
                <div class="card widget-card-1">
                    <div class="card-block-big">
                        <i class="ti-layout-list-thumb bg-c-orenge card1-icon"></i>
                        <br />
                        <h4 style="text-align: center;">
                            @Localizer["Search Machine By Hierarchies"].Value
                        </h4>
                        <br />
                        <div>
                            <span class="f-left" style="text-align:center; width: 100%;">
                                <button id="SearchByHierarchies" style="width:100%; height:40px; color: black; font-size: 15px; font-weight:700;" class="btn btn-success">@Localizer["Search"].Value</button>
                            </span>
                        </div>
                        <br />
                        <br />
                    </div>
                </div>
            </div>
            @*}*@
        </div>
    </div>
</body>

<div class="modal" id="modalQR" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content rounded-0">
            <div class="modal-header bg-c-green">
                <div class="col-2">
                    <i style="color:white;font-size:30px;" class="icofont icofont-qr-code bg-c-green"></i>
                </div>
                <div class="col-8">
                    <h3 style="color:white;text-align:center;" class="modal-title">@Localizer["Read QR Code"].Value</h3>
                </div>
                <div class="col-2">
                    <button style="margin-top:-8px;" type="button" class="close" data-dismiss="modal"><span aria-hidden="true" class="c-m-btn">×</span><span class="sr-only">@Localizer["Close"].Value</span></button>
                </div>
            </div>

            <div  class="modal-body text-center p-b-50">
                <br />
                <div id="qr-reader" style="width:350px; margin-left:auto; margin-right:auto;"></div>
            </div>
            <script>
                var html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
                html5QrcodeScanner.render(onScanSuccess);
            </script>

        </div>
    </div>
</div>
